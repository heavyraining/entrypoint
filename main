local player = game:GetService("Players").LocalPlayer

local defaultImage = "rbxassetid://10272740627"
local function CoreGuiNotification(title, text, duration, icon)
	game:GetService("StarterGui"):SetCore("SendNotification", {
		Title = title or "Notification",
		Text = text or "",
		Duration = duration or 5,
		Icon = icon or defaultImage
	})
end

if not player.Character then
	CoreGuiNotification("Waiting...", "The GUI will load once the mission starts, press M to unlock mouse.", 10)
	player.CharacterAdded:Wait()
end

local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/heavyraining/ModifiedKavoUI/refs/heads/main/main"))()
local Window = Library.CreateLib("Entry Point ESP/Aimlock", "DarkTheme")

local EspTab = Window:NewTab("ESP")
local ClassEspSection = EspTab:NewSection("Class ESP")
local SettingsSection = EspTab:NewSection("Settings")

local function findFirstChildByNamePrefix(instance, prefix)
	for _, child in ipairs(instance:GetChildren()) do
		if string.sub(child.Name, 1, #prefix) == prefix then
			return child
		end
	end
	return nil
end

local levelFolder = workspace:WaitForChild("Level")
local instanceFolder = findFirstChildByNamePrefix(levelFolder, "Instance")

local connections = {}
local toggles = {}
local espState = {}
local activeEsp = {}
local includeDead = false
local assignedColors = {}
local modelClassMap = {}

local classColorOverrides = {
	Civ = Color3.fromRGB(255,255,255),
	Combat = Color3.fromRGB(102,102,102)
}

local classTextTranslations = {
	Sec = "Security",
	Emp = "Employee",
	Civ = "Civilian",
	Combat = "SWAT"
}

local preClass = {
	"Combat",
	"Sec",
	"Civ"
}

local function closeConnections()
	for _, c in ipairs(connections) do
		c:Disconnect()
	end
	table.clear(connections)
end

local function generateColorFromString(str)
	local hash = 0
	for i = 1, #str do
		hash += string.byte(str, i) * i
	end
	return Color3.fromHSV((hash % 360)/360, 0.8, 1)
end

local function getColorForClass(class)
	if classColorOverrides[class] then
		return classColorOverrides[class]
	end
	if not assignedColors[class] then
		assignedColors[class] = generateColorFromString(class)
	end
	return assignedColors[class]
end

local function getDisplayName(class)
	return classTextTranslations[class] or class
end

local function isDead(model)
	return model:FindFirstChild("Folder", true) or model:FindFirstChild("Joints", true) ~= nil
end

local function removeEsp(model)
	local data = activeEsp[model]
	if not data then return end
	if data.Highlight then data.Highlight:Destroy() end
	if data.Billboard then data.Billboard:Destroy() end
	activeEsp[model] = nil
end

local function addEsp(model, class)
	if not espState[class] then
		removeEsp(model)
		return
	end

	local dead = isDead(model)

	if not includeDead and dead then
		removeEsp(model)
		return
	end

	if activeEsp[model] then
		removeEsp(model)
	end

	local color = getColorForClass(class)

	local highlight = Instance.new("Highlight")
	highlight.FillColor = color
	highlight.OutlineColor = color
	highlight.FillTransparency = dead and 0.85 or 0.5
	highlight.OutlineTransparency = dead and 0.85 or 0.5
	highlight.Parent = model

	local billboard = Instance.new("BillboardGui")
	billboard.Size = UDim2.new(0,120,0,30)
	billboard.AlwaysOnTop = true
	billboard.StudsOffset = Vector3.new(0,3,0)
	billboard.Parent = model

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1,0,1,0)
	label.BackgroundTransparency = 1
	label.TextTransparency = dead and 0.5 or 0
	label.RichText = true
	label.TextScaled = true

	local display = "<b>" .. string.upper(getDisplayName(class)) .. "</b>"
	if dead then
		display = display .. " (dead/KO)"
	end

	label.Text = display
	label.TextColor3 = color
	label.TextStrokeTransparency = 0
	label.Parent = billboard

	activeEsp[model] = {
		Highlight = highlight,
		Billboard = billboard
	}
end

local function rebuildEsp()
	for model in pairs(activeEsp) do
		removeEsp(model)
	end
	for model, class in pairs(modelClassMap) do
		addEsp(model, class)
	end
end

SettingsSection:NewToggle(
	"Include Dead/KO Bots",
	"Includes Dead/KO bots in the ESP though they'll have special markings to help differentiate.",
	function(state)
		includeDead = state
		rebuildEsp()
	end
)

local function hook()
	closeConnections()
	table.clear(modelClassMap)

	local botDataFolder = instanceFolder:WaitForChild("BotData")
	local botModelFolder = instanceFolder:WaitForChild("BotModel")

	local function createToggle(class)
		if toggles[class] then return end
		espState[class] = false

		toggles[class] = ClassEspSection:NewToggle(
			getDisplayName(class) .. " ESP",
			"",
			function(state)
				espState[class] = state
				rebuildEsp()
			end
		)

		CoreGuiNotification("Class Loaded", class .. " toggle loaded.", 3)
	end

	local function bindModel(model, class)
		modelClassMap[model] = class

		table.insert(connections, model.ChildAdded:Connect(function(child)
			print(child:GetFullName())
			if child.Name == "Folder" or child.Name == "Joints" then
				addEsp(model, class)
			end
		end))

		table.insert(connections, model.ChildRemoved:Connect(function(child)
			if child.Name == "Folder" or child.Name == "Joints" then
				addEsp(model, class)
			end
		end))

		addEsp(model, class)
	end

	local function mapNpc(npc)
		local class = npc:GetAttribute("Class")
		if not class then return end

		createToggle(class)

		for _, model in ipairs(botModelFolder:GetChildren()) do
			for _, attr in pairs(model:GetAttributes()) do
				if attr == npc.Name then
					bindModel(model, class)
					break
				end
			end
		end
	end

	for _, npc in ipairs(botDataFolder:GetChildren()) do
		mapNpc(npc)
	end
	
	for _, pre in ipairs(preClass) do
		createToggle(pre)
	end

	table.insert(connections, botDataFolder.ChildAdded:Connect(mapNpc))
end

local function initiate()
	levelFolder.ChildAdded:Connect(function()
		local newInstanceFolder = findFirstChildByNamePrefix(levelFolder, "Instance")
		if newInstanceFolder then
			instanceFolder = newInstanceFolder
			hook()
		end
	end)

	hook()

	CoreGuiNotification("Loaded", "ESP system loaded successfully.", 6)
end

initiate()
