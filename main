local player = game:GetService("Players").LocalPlayer

local defaultImage = "rbxassetid://10272740627"
local function CoreGuiNotification(title, text, duration, icon)
	game:GetService("StarterGui"):SetCore("SendNotification", {
		Title = title or "Notification",
		Text = text or "",
		Duration = duration or 5,
		Icon = icon or defaultImage
	})
end

if not player.Character then
	CoreGuiNotification("Waiting...", "The GUI will load once the mission starts, press M to unlock mouse.", 10)
	player.CharacterAdded:Wait()
end

local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/heavyraining/ModifiedKavoUI/refs/heads/main/main"))()
local Window = Library.CreateLib("Entry Point ESP/Aimlock", "DarkTheme")

local EspTab = Window:NewTab("ESP")
local AimlockTab = Window:NewTab("Aimlock")

local ClassEspSection = EspTab:NewSection("Classes")
local SettingsSection = EspTab:NewSection("Settings")

local function findFirstChildByNamePrefix(instance, prefix)
	for _, child in ipairs(instance:GetChildren()) do
		if string.sub(child.Name, 1, #prefix) == prefix then
			return child
		end
	end
	return nil
end

local levelFolder: Folder = workspace.Level
local instanceFolder: Folder = findFirstChildByNamePrefix(levelFolder, "Instance")

local connections = {}

local function closeConnections()
	for _, connection in ipairs(connections) do
		connection:Disconnect()
	end
	table.clear(connections)
end

local toggles = {}
local espState = {}
local activeEsp = {}
local includeDead = false
local assignedColors = {}

local classColorOverrides = {
	Civ = Color3.fromRGB(255, 255, 255),
	Combat = Color3.fromRGB(102, 102, 102)
}

local classTextTranslations = {
	Sec = "Security",
	Emp = "Employee",
	Civ = "Civilian"
}

local function generateColorFromString(str)
	local hash = 0
	for i = 1, #str do
		hash = hash + string.byte(str, i) * i
	end
	local hue = (hash % 360) / 360
	return Color3.fromHSV(hue, 0.8, 1)
end

local function getColorForClass(class)
	if classColorOverrides[class] then
		return classColorOverrides[class]
	end
	if not assignedColors[class] then
		assignedColors[class] = generateColorFromString(class)
	end
	return assignedColors[class]
end

local function getDisplayName(class)
	return classTextTranslations[class] or class
end

local function getModelForNpc(botModelFolder, npc)
	for _, model in ipairs(botModelFolder:GetChildren()) do
		for _, attrValue in pairs(model:GetAttributes()) do
			if attrValue == npc.Name then
				return model
			end
		end
	end
	return nil
end

local function addEsp(model, class)
	if not model then return end
	if activeEsp[model] then return end
	if not includeDead and model:FindFirstChild("Joints") then return end

	local color = getColorForClass(class)
	local displayName = getDisplayName(class)

	local highlight = Instance.new("Highlight")
	highlight.FillColor = color
	highlight.OutlineColor = color
	highlight.FillTransparency = 0.5
	highlight.Parent = model

	local billboard = Instance.new("BillboardGui")
	billboard.Size = UDim2.new(0, 120, 0, 30)
	billboard.AlwaysOnTop = true
	billboard.Parent = model

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1, 0, 1, 0)
	label.BackgroundTransparency = 1
	label.RichText = true
	label.TextScaled = true
	label.Text = "<b>" .. string.upper(displayName) .. "</b>"
	label.TextColor3 = color
	label.TextStrokeTransparency = 0
	label.Parent = billboard

	activeEsp[model] = {
		Highlight = highlight,
		Billboard = billboard
	}
end

local function removeEsp(model)
	local data = activeEsp[model]
	if not data then return end
	if data.Highlight then data.Highlight:Destroy() end
	if data.Billboard then data.Billboard:Destroy() end
	activeEsp[model] = nil
end

SettingsSection:NewToggle(
	"Include Dead Bots",
	"If enabled, ESP will include bots with Joints (dead).",
	function(state)
		includeDead = state
		for model in pairs(activeEsp) do
			if not includeDead and model:FindFirstChild("Joints") then
				removeEsp(model)
			else
				local class = model:GetAttribute("Class")
				if espState[class] then
					addEsp(model, class)
				end
			end
		end
	end
)

local function hook()
	closeConnections()

	local botDataFolder: Folder = instanceFolder:WaitForChild("BotData")
	local botModelFolder: Folder = instanceFolder:WaitForChild("BotModel")

	local trackedNpcs = {}

	local function tryApply(npc)
		local class = npc:GetAttribute("Class")
		if not class then return end
		if not espState[class] then return end

		local model = getModelForNpc(botModelFolder, npc)
		if not model then return end

		if not includeDead and model:FindFirstChild("Joints") then
			removeEsp(model)
			return
		end

		addEsp(model, class)
	end

	local function createClassToggle(class)
		if toggles[class] then return end

		local displayName = getDisplayName(class)
		espState[class] = espState[class] or false

		toggles[class] = ClassEspSection:NewToggle(
			displayName .. " ESP",
			"Toggles ESP for " .. displayName,
			function(state)
				espState[class] = state
				for _, npc in ipairs(botDataFolder:GetChildren()) do
					if npc:GetAttribute("Class") == class then
						local model = getModelForNpc(botModelFolder, npc)
						if model then
							if state then
								addEsp(model, class)
							else
								removeEsp(model)
							end
						end
					end
				end
			end
		)

		CoreGuiNotification("Class Loaded", displayName .. " toggle has been loaded in the GUI.", 3)
	end

	local function trackNpc(npc)
		trackedNpcs[npc] = true

		table.insert(connections,
			npc:GetAttributeChangedSignal("Class"):Connect(function()
				local class = npc:GetAttribute("Class")
				if class then
					createClassToggle(class)
					tryApply(npc)
				end
			end)
		)
		
		for attrName, attrValue in pairs(npc:GetAttributes()) do
			if string.sub(attrName, 1, 1) == "v" and typeof(attrValue) == "NumberValue" then
				table.insert(connections,
					npc:GetAttributeChangedSignal(attrName):Connect(function()
						local health = npc:GetAttribute(attrName)
						local model = getModelForNpc(botModelFolder, npc)
						
						if health <= 0 and model then
							if not includeDead then
								removeEsp(model)
							end
						elseif health > 0 and model then
							addEsp(model, npc:GetAttribute("Class"))
						end
					end)
				)
			end
		end

		local class = npc:GetAttribute("Class")
		if class then
			createClassToggle(class)
			tryApply(npc)
		end
	end

	for _, npc in ipairs(botDataFolder:GetChildren()) do
		trackNpc(npc)
	end

	table.insert(connections, botDataFolder.ChildAdded:Connect(trackNpc))

	table.insert(connections,
		botModelFolder.ChildAdded:Connect(function()
			for npc in pairs(trackedNpcs) do
				tryApply(npc)
			end
		end)
	)

	table.insert(connections,
		botDataFolder.ChildRemoved:Connect(function(npc)
			local model = getModelForNpc(botModelFolder, npc)
			if model then
				removeEsp(model)
			end
			trackedNpcs[npc] = nil
		end)
	)
end

local function initiate()
	levelFolder.ChildAdded:Connect(function()
		local newInstanceFolder = findFirstChildByNamePrefix(levelFolder, "Instance")
		if newInstanceFolder then
			instanceFolder = newInstanceFolder
			hook()
		end
	end)

	hook()
	
	CoreGuiNotification("Loaded", "The GUI has been loaded. If you don't see a class toggle that you need, it is because the class hasn't appeared in the map yet.", 7)
end

initiate()
